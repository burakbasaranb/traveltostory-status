name: Update Last Update Badge

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout public repo
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate Badge
        run: |
          export LC_TIME=en_US.UTF-8
          date_str=$(TZ=UTC date +"%d %b %Y %H:%M UTC")
          date_length=${#date_str}
          label_width=110
          value_width=$((date_length * 7 + 20))
          total_width=$((label_width + value_width))

          echo "<svg xmlns='http://www.w3.org/2000/svg' width='${total_width}' height='20'>
          <defs>
            <linearGradient id='bg' x1='0' x2='0' y1='0' y2='1'>
              <stop offset='0' stop-color='#555' stop-opacity='1'/>
              <stop offset='1' stop-color='#444' stop-opacity='1'/>
            </linearGradient> 
            <linearGradient id='valueBg' x1='0' x2='0' y1='0' y2='1'>
              <stop offset='0' stop-color='#4caf50' stop-opacity='1'/>
              <stop offset='1' stop-color='#388e3c' stop-opacity='1'/>
            </linearGradient>
            <clipPath id='rounded-right'>
              <rect x='${label_width}' y='0' width='${value_width}' height='20' rx='3'/>
            </clipPath>
          </defs>
          <rect width='${total_width}' height='20' fill='url(#bg)' rx='3'/>
          <rect x='${label_width}' y='0' width='${value_width}' height='20' fill='url(#valueBg)' clip-path='url(#rounded-right)'/>
          <text x='12' y='14' fill='#fff' font-family='-apple-system,BlinkMacSystemFont,Segoe UI,Helvetica,Arial,sans-serif' font-size='11' font-weight='500'>Last Update</text>
          <text x='$((label_width + 10))' y='14' fill='#fff' font-family='-apple-system,BlinkMacSystemFont,Segoe UI,Helvetica,Arial,sans-serif' font-size='11' font-weight='600'>${date_str}</text>
          </svg>" > last_update.svg

      - name: Update README with cache-busting
        run: |
          timestamp=$(date +%s)
          sed -i "s/last_update\.svg?v=[0-9]*/last_update.svg?v=${timestamp}/" README.md || sed -i "s/last_update\.svg/last_update.svg?v=${timestamp}/" README.md

      - name: Commit Badge
        run: |
          git config --global user.email "bot@github.com"
          git config --global user.name "UpdateBot"
          git add last_update.svg README.md
          git commit -m "Update badge" || echo "No changes"
          git push
